# load("//third_party/bazel_rules/rules_cc/cc:cc_test.bzl", "cc_test")
load("@org_xprof//plugin/xprof/build_utils/google:build_config.bzl", "cc_library")

package(
    # copybara:uncomment default_applicable_licenses = ["//xprof:license"],
    default_visibility = ["@org_xprof//xprof/convert:__subpackages__"],
    licenses = ["notice"],
)

cc_library(
    name = "profile_processor_factory",
    srcs = ["profile_processor_factory.cc"],
    hdrs = ["profile_processor_factory.h"],
    visibility = [
        "@org_xprof//plugin/xprof/worker:__pkg__",
        "@org_xprof//xprof/convert:__subpackages__",
    ],
    deps = [
        ":profile_processor",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/functional:any_invocable",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/strings",
        "@org_xprof//xprof/convert:tool_options",
    ],
)

cc_library(
    name = "profile_processor",
    hdrs = ["profile_processor.h"],
    deps = [
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
    ],
)

cc_library(
    name = "op_stats_processor",
    srcs = ["op_stats_processor.cc"],
    hdrs = ["op_stats_processor.h"],
    deps = [
        ":profile_processor",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_protobuf//:protobuf",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:op_stats_combiner",
        "@org_xprof//xprof/convert:preprocess_single_host_xplane",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_op_stats",
        "@org_xprof//xprof/utils:hardware_type_utils",
        "@org_xprof//xprof/utils:step_intersection",
        "@tsl//tsl/platform:path",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:env",
        "@xla//xla/tsl/platform:errors",
        "@xla//xla/tsl/platform:statusor",
        "@xla//xla/tsl/platform:types",
    ],
)

cc_library(
    name = "overview_page_processor",
    srcs = ["overview_page_processor.cc"],
    hdrs = ["overview_page_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:overview_page_proto_cc",
        "@org_xprof//xprof/convert:compute_inference_latency",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:multi_xspace_to_inference_stats",
        "@org_xprof//xprof/convert:op_stats_to_overview_page",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "memory_viewer_processor",
    srcs = ["memory_viewer_processor.cc"],
    hdrs = ["memory_viewer_processor.h"],
    deps = [
        ":profile_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:dcn_slack_analysis_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:hardware_types_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:inference_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:input_pipeline_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:kernel_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_profile_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:overview_page_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:roofline_model_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:tf_data_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:tf_stats_proto_cc",
        "@org_xprof//xprof/convert:hlo_proto_to_graph_view",
        "@org_xprof//xprof/convert:hlo_proto_to_memory_visualization_utils",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_hlo",
        "@tsl//tsl/platform:protobuf",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
        "@xla//xla/tsl/platform:statusor",
    ],
    alwayslink = 1,
)

cc_library(
    name = "graph_viewer_processor",
    srcs = ["graph_viewer_processor.cc"],
    hdrs = ["graph_viewer_processor.h"],
    deps = [
        ":profile_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:dcn_slack_analysis_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:hardware_types_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:inference_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:input_pipeline_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:kernel_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_profile_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:overview_page_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:roofline_model_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:tf_data_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:tf_stats_proto_cc",
        "@org_xprof//xprof/convert:hlo_proto_to_graph_view",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_hlo",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:statusor",
    ],
    alwayslink = 1,
)

cc_library(
    name = "trace_viewer_processor",
    srcs = ["trace_viewer_processor.cc"],
    hdrs = ["trace_viewer_processor.h"],
    deps = [
        ":profile_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings:string_view",
        "@com_google_protobuf//:protobuf",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:preprocess_single_host_xplane",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
        "@xla//xla/tsl/platform:statusor",
        "@xla//xla/tsl/profiler/convert:xplane_to_trace_events",
    ],
    alwayslink = 1,
)

cc_library(
    name = "streaming_trace_viewer_processor",
    srcs = ["streaming_trace_viewer_processor.cc"],
    hdrs = ["streaming_trace_viewer_processor.h"],
    deps = [
        ":profile_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/strings:string_view",
        "@com_google_protobuf//:protobuf",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:preprocess_single_host_xplane",
        "@org_xprof//xprof/convert:process_megascale_dcn",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_trace_container",
        "@org_xprof//xprof/convert/trace_viewer:trace_events",
        "@org_xprof//xprof/convert/trace_viewer:trace_events_to_json",
        "@org_xprof//xprof/convert/trace_viewer:trace_options",
        "@org_xprof//xprof/convert/trace_viewer:trace_viewer_visibility",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:env",
        "@xla//xla/tsl/platform:errors",
        "@xla//xla/tsl/platform:statusor",
        "@xla//xla/tsl/profiler/utils:timespan",
    ],
    alwayslink = 1,
)

cc_library(
    name = "inference_stats_processor",
    srcs = ["inference_stats_processor.cc"],
    hdrs = ["inference_stats_processor.h"],
    deps = [
        ":profile_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:multi_xspace_to_inference_stats",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "megascale_stats_processor",
    srcs = ["megascale_stats_processor.cc"],
    hdrs = ["megascale_stats_processor.h"],
    deps = [
        ":profile_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:dcn_slack_analysis_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:hardware_types_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:inference_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:input_pipeline_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:kernel_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_profile_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:overview_page_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:roofline_model_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:tf_data_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:tf_stats_proto_cc",
        "@org_xprof//xprof/convert:process_megascale_dcn",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_dcn_collective_stats",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:statusor",
    ],
    alwayslink = 1,
)

cc_library(
    name = "memory_profile_processor",
    srcs = ["memory_profile_processor.cc"],
    hdrs = ["memory_profile_processor.h"],
    deps = [
        ":profile_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings:string_view",
        "@com_google_protobuf//:protobuf",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:preprocess_single_host_xplane",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_memory_profile",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
        "@xla//xla/tsl/platform:statusor",
    ],
    alwayslink = 1,
)

cc_library(
    name = "kernel_stats_processor",
    srcs = ["kernel_stats_processor.cc"],
    hdrs = ["kernel_stats_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_kernel_stats_db",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "pod_viewer_processor",
    srcs = ["pod_viewer_processor.cc"],
    hdrs = ["pod_viewer_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:op_stats_to_pod_viewer",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/platform:protobuf",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "op_profile_processor",
    srcs = ["op_profile_processor.cc"],
    hdrs = ["op_profile_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:op_profile_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:op_stats_to_op_profile",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/utils:hardware_type_utils",
        "@tsl//tsl/platform:protobuf",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "hlo_stats_processor",
    srcs = ["hlo_stats_processor.cc"],
    hdrs = ["hlo_stats_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/status",
        "@org_xprof//plugin/xprof/protobuf:hlo_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:op_stats_to_hlo_stats",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "roofline_model_processor",
    srcs = ["roofline_model_processor.cc"],
    hdrs = ["roofline_model_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:roofline_model_proto_cc",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:op_stats_to_roofline_model",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "framework_op_stats_processor",
    srcs = ["framework_op_stats_processor.cc"],
    hdrs = ["framework_op_stats_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:tf_stats_proto_cc",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:op_stats_to_tf_stats",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_library(
    name = "input_pipeline_processor",
    srcs = ["input_pipeline_processor.cc"],
    hdrs = ["input_pipeline_processor.h"],
    deps = [
        ":op_stats_processor",
        ":profile_processor_factory",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings:string_view",
        "@org_xprof//plugin/xprof/protobuf:input_pipeline_proto_cc",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:multi_xplanes_to_op_stats",
        "@org_xprof//xprof/convert:op_stats_to_input_pipeline_analysis",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:errors",
    ],
    alwayslink = 1,
)

cc_test(
    name = "profile_processor_test",
    srcs = ["profile_processor_test.cc"],
    deps = [
        ":overview_page_processor",
        ":profile_processor",
        ":profile_processor_factory",
        "//file/base",
        "//file/base:options_cc",
        "//file/base:path",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@com_google_googletest//:gtest_main",
        "@org_xprof//plugin/xprof/protobuf:op_stats_proto_cc",
        "@org_xprof//xprof/convert:repository",
        "@org_xprof//xprof/convert:tool_options",
        "@org_xprof//xprof/convert:xplane_to_tools_data",
        "@tsl//tsl/platform:path",
        "@tsl//tsl/profiler/protobuf:xplane_proto_cc",
        "@xla//xla/tsl/platform:env",
    ],
)
